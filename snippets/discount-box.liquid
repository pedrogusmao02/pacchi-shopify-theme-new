<div class="discount-box{% if class %} {{ class }}{% endif %}">
  <form id="DiscountForm" autocomplete="off">
    <label for="discount-code" class="discount-box__label">Aplicar código de desconto</label>
    <div class="discount-box__input-group">
      <input type="text" id="discount-code" name="discount" class="discount-box__input" placeholder="Código de desconto" required>
      <button type="submit" class="discount-box__button">Aplicar</button>
    </div>
    <div id="DiscountMessage" class="discount-box__message" style="display:none;"></div>
  </form>
</div>

<script>
(function() {
  function initDiscountBox() {
    var form = document.getElementById('DiscountForm');
    var input = document.getElementById('discount-code');
    var message = document.getElementById('DiscountMessage');
    
    if (!form) return;
    
    // Clear any existing event listeners
    form.removeEventListener('submit', handleSubmit);
    form.addEventListener('submit', handleSubmit);
    
    function handleSubmit(e) {
      e.preventDefault();
      var code = input.value.trim();
      if (!code) return;
      
      message.style.display = 'none';
      message.textContent = '';
      form.classList.add('is-loading');
      
      fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ attributes: {}, discount: code })
      })
      .then(function(res) { 
        if (!res.ok) {
          throw new Error('Network response was not ok');
        }
        return res.json(); 
      })
      .then(function(data) {
        if (data.status && data.status !== 200) {
          throw new Error(data.description || 'Error applying discount');
        }
        
        message.textContent = 'Desconto aplicado!';
        message.style.display = 'block';
        message.className = 'discount-box__message discount-box__message--success';
        
        // Update cart sections
        if (window.location.pathname.indexOf('/cart') !== -1) {
          window.location.reload();
        } else {
          // Update cart drawer contents
          const cartDrawer = document.querySelector('cart-drawer');
          if (cartDrawer && typeof cartDrawer.renderContents === 'function') {
            // Fetch updated cart data and render
            fetch('/?section_id=cart-drawer')
              .then(response => response.text())
              .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newCartDrawer = doc.querySelector('cart-drawer');
                if (newCartDrawer) {
                  cartDrawer.innerHTML = newCartDrawer.innerHTML;
                  // Re-initialize the discount box in the updated drawer
                  setTimeout(initDiscountBox, 100);
                }
              })
              .catch(() => {
                // Fallback to page reload
                window.location.reload();
              });
          } else {
            // fallback: reload
            window.location.reload();
          }
        }
      })
      .catch(function(err) {
        message.textContent = err.message || 'Não foi possível aplicar o desconto.';
        message.style.display = 'block';
        message.className = 'discount-box__message discount-box__message--error';
      })
      .finally(function() {
        form.classList.remove('is-loading');
      });
    }
  }
  
  // Initialize on page load
  initDiscountBox();
  
  // Re-initialize when cart drawer content is updated
  document.addEventListener('cart:updated', initDiscountBox);
})();
</script>

<style>
.discount-box {
  margin-bottom: 1.5rem;
}
.discount-box__label {
  display: block;
  margin-bottom: 0.5rem;
  font-size: 1.1rem;
  font-weight: 500;
  color: rgb(var(--color-heading-text));
}
.discount-box__input-group {
  display: flex;
  gap: 0.5rem;
}
.discount-box__input {
  flex: 1;
  padding: 0.75rem;
  border: 1px solid rgb(var(--color-border));
  border-radius: 4px;
  font-size: 1.1rem;
  background: rgb(var(--color-background));
  color: rgb(var(--color-text));
}
.discount-box__input:focus {
  outline: none;
  border-color: rgb(var(--color-accent));
}
.discount-box__button {
  padding: 0.75rem 1rem;
  background: rgb(var(--color-button));
  color: rgb(var(--color-button-text));
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  font-weight: 500;
  white-space: nowrap;
  transition: background-color 0.2s ease;
}
.discount-box__button:hover {
  background: rgb(var(--color-button-hover));
}
.discount-box__button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
.discount-box__message {
  margin-top: 0.5rem;
  font-size: 0.85rem;
  padding: 0.5rem;
  border-radius: 4px;
}
.discount-box__message--success {
  color: #059669;
  background: #d1fae5;
  border: 1px solid #a7f3d0;
}
.discount-box__message--error {
  color: #dc2626;
  background: #fee2e2;
  border: 1px solid #fecaca;
}
.discount-box.is-loading .discount-box__button {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Cart drawer specific styles */
.cart-drawer__discount-box {
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgb(var(--color-border));
}
.cart-drawer__discount-box .discount-box__label {
  font-size: 1.05rem;
  margin-bottom: 0.4rem;
}
.cart-drawer__discount-box .discount-box__input {
  padding: 0.6rem;
  font-size: 1.05rem;
}
.cart-drawer__discount-box .discount-box__button {
  padding: 0.6rem 0.8rem;
  font-size: 0.85rem;
}
.cart-drawer__discount-box .discount-box__message {
  font-size: 0.8rem;
  margin-top: 0.4rem;
}

/* Main cart page specific styles */
.cart__discount-box {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: rgb(var(--color-background-secondary));
  border-radius: 8px;
  border: 1px solid rgb(var(--color-border));
}
.cart__discount-box .discount-box__label {
  font-size: 0.95rem;
  margin-bottom: 0.5rem;
}
.cart__discount-box .discount-box__input {
  padding: 0.75rem;
  font-size: 0.95rem;
}
.cart__discount-box .discount-box__button {
  padding: 0.75rem 1rem;
  font-size: 0.95rem;
}
.cart__discount-box .discount-box__message {
  font-size: 0.9rem;
  margin-top: 0.5rem;
}
</style> 